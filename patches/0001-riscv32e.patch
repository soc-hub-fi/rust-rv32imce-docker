From 58003db38c352734c4a0a0a378a7134e845a86a4 Mon Sep 17 00:00:00 2001
From: Henri Lunnikivi <henri.lunnikivi@tuni.fi>
Date: Mon, 29 Apr 2024 13:01:10 +0300
Subject: [PATCH 1/5] riscv32e

---
 compiler/rustc_target/src/spec/mod.rs         |  2 ++
 .../spec/targets/riscv32e_unknown_none_elf.rs | 31 +++++++++++++++++++
 2 files changed, 33 insertions(+)
 create mode 100644 compiler/rustc_target/src/spec/targets/riscv32e_unknown_none_elf.rs

diff --git a/compiler/rustc_target/src/spec/mod.rs b/compiler/rustc_target/src/spec/mod.rs
index fe07d116..b2421cd9 100644
--- a/compiler/rustc_target/src/spec/mod.rs
+++ b/compiler/rustc_target/src/spec/mod.rs
@@ -1750,6 +1750,8 @@ fn $module() {
     ("riscv64gc-unknown-linux-gnu", riscv64gc_unknown_linux_gnu),
     ("riscv64gc-unknown-linux-musl", riscv64gc_unknown_linux_musl),
 
+    ("riscv32e-unknown-none-elf", riscv32e_unknown_none_elf),
+
     ("sparc-unknown-none-elf", sparc_unknown_none_elf),
 
     ("loongarch64-unknown-none", loongarch64_unknown_none),
diff --git a/compiler/rustc_target/src/spec/targets/riscv32e_unknown_none_elf.rs b/compiler/rustc_target/src/spec/targets/riscv32e_unknown_none_elf.rs
new file mode 100644
index 00000000..6325b53d
--- /dev/null
+++ b/compiler/rustc_target/src/spec/targets/riscv32e_unknown_none_elf.rs
@@ -0,0 +1,31 @@
+use crate::spec::{Cc, LinkerFlavor, Lld, PanicStrategy, RelocModel, Target, TargetOptions};
+
+pub fn target() -> Target {
+    Target {
+        data_layout: "e-m:e-p:32:32-i64:64-n32-S128".into(),
+        llvm_target: "riscv32".into(),
+        pointer_width: 32,
+        arch: "riscv32".into(),
+        metadata: crate::spec::TargetMetadata {
+            description: Some("Bare RISC-V (RV32E ISA)".into()),
+            tier: None,
+            host_tools: Some(false),
+            std: Some(false),
+        },
+
+        options: TargetOptions {
+            linker_flavor: LinkerFlavor::Gnu(Cc::No, Lld::Yes),
+            linker: Some("rust-lld".into()),
+            cpu: "generic-rv32".into(),
+            max_atomic_width: Some(32),
+            atomic_cas: false,
+            features: "+e,+forced-atomics".into(),
+            panic_strategy: PanicStrategy::Abort,
+            relocation_model: RelocModel::Static,
+            emit_debug_gdb_scripts: false,
+            eh_frame_header: false,
+            llvm_abiname: "ilp32e".into(),
+            ..Default::default()
+        },
+    }
+}
-- 
2.34.1

